"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Session = void 0;
var tslib_1 = require("tslib");
var error_1 = require("../error");
var scopes_1 = require("../auth/scopes");
var propertiesToSave = [
    'id',
    'shop',
    'state',
    'isOnline',
    'scope',
    'accessToken',
    'expires',
    'onlineAccessInfo',
];
/**
 * Stores App information from logged in merchants so they can make authenticated requests to the Admin API.
 */
var Session = /** @class */ (function () {
    function Session(params) {
        Object.assign(this, params);
    }
    Session.fromPropertyArray = function (entries) {
        if (!Array.isArray(entries)) {
            throw new error_1.InvalidSession('The parameter is not an array: a Session cannot be created from this object.');
        }
        var obj = Object.fromEntries(entries
            .filter(function (_a) {
            var _b = tslib_1.__read(_a, 2), _key = _b[0], value = _b[1];
            return value !== null && value !== undefined;
        })
            // Sanitize keys
            .map(function (_a) {
            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];
            switch (key.toLowerCase()) {
                case 'isonline':
                    return ['isOnline', value];
                case 'accesstoken':
                    return ['accessToken', value];
                case 'onlineaccessinfo':
                    return ['onlineAccessInfo', value];
                default:
                    return [key.toLowerCase(), value];
            }
        })
            // Sanitize values
            .map(function (_a) {
            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];
            switch (key) {
                case 'isOnline':
                    if (typeof value === 'string') {
                        return [key, value.toString().toLowerCase() === 'true'];
                    }
                    else if (typeof value === 'number') {
                        return [key, Boolean(value)];
                    }
                    return [key, value];
                case 'scope':
                    return [key, value.toString()];
                case 'expires':
                    return [key, value ? new Date(Number(value)) : undefined];
                case 'onlineAccessInfo':
                    return [
                        key,
                        {
                            associated_user: {
                                id: Number(value),
                            },
                        },
                    ];
                default:
                    return [key, value];
            }
        }));
        Object.setPrototypeOf(obj, Session.prototype);
        return obj;
    };
    Session.prototype.isActive = function (scopes) {
        var scopesObject = scopes instanceof scopes_1.AuthScopes ? scopes : new scopes_1.AuthScopes(scopes);
        var scopesUnchanged = scopesObject.equals(this.scope);
        if (scopesUnchanged &&
            this.accessToken &&
            (!this.expires || this.expires >= new Date())) {
            return true;
        }
        return false;
    };
    Session.prototype.toObject = function () {
        var object = {
            id: this.id,
            shop: this.shop,
            state: this.state,
            isOnline: this.isOnline,
        };
        if (this.scope) {
            object.scope = this.scope;
        }
        if (this.expires) {
            object.expires = this.expires;
        }
        if (this.accessToken) {
            object.accessToken = this.accessToken;
        }
        if (this.onlineAccessInfo) {
            object.onlineAccessInfo = this.onlineAccessInfo;
        }
        return object;
    };
    Session.prototype.equals = function (other) {
        if (!other)
            return false;
        var mandatoryPropsMatch = this.id === other.id &&
            this.shop === other.shop &&
            this.state === other.state &&
            this.isOnline === other.isOnline;
        if (!mandatoryPropsMatch)
            return false;
        var copyA = this.toPropertyArray();
        copyA.sort(function (_a, _b) {
            var _c = tslib_1.__read(_a, 1), k1 = _c[0];
            var _d = tslib_1.__read(_b, 1), k2 = _d[0];
            return (k1 < k2 ? -1 : 1);
        });
        var copyB = other.toPropertyArray();
        copyB.sort(function (_a, _b) {
            var _c = tslib_1.__read(_a, 1), k1 = _c[0];
            var _d = tslib_1.__read(_b, 1), k2 = _d[0];
            return (k1 < k2 ? -1 : 1);
        });
        return JSON.stringify(copyA) === JSON.stringify(copyB);
    };
    Session.prototype.toPropertyArray = function () {
        return (Object.entries(this)
            .filter(function (_a) {
            var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];
            return propertiesToSave.includes(key) &&
                value !== undefined &&
                value !== null;
        })
            // Prepare values for db storage
            .map(function (_a) {
            var _b;
            var _c = tslib_1.__read(_a, 2), key = _c[0], value = _c[1];
            switch (key) {
                case 'expires':
                    return [key, value ? value.getTime() : undefined];
                case 'onlineAccessInfo':
                    return [key, (_b = value === null || value === void 0 ? void 0 : value.associated_user) === null || _b === void 0 ? void 0 : _b.id];
                default:
                    return [key, value];
            }
        }));
    };
    return Session;
}());
exports.Session = Session;
//# sourceMappingURL=session.js.map